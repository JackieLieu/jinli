$(function(){FastClick.attach(document.body);login();getVerCode();gift();loadMore();weixinConfig();});var enumMsg={phoneAndPwdNull:"请输入账号、密码",pwdNull:"请输入密码",pwdNotEqual:"两次输入的密码不一致",pwdIllegal:"密码为4-16位的字母或数字",pwdError:"密码错误",phoneNull:"请输入手机号码",phoneIllegal:"手机号码有误",verifyFail:"验证失败",codeNull:"请输入验证码",codeError:"验证码错误",codeSendSuccess:"验证码发送成功",loginSuccess:"登录成功",registerSuccess:"注册成功"};
var enumStatusCode={1011:"账号或密码错误",1101:"验证码错误",1100:"账号已存在",unknow:"网络异常，请检查后重试",timeout:"请求超时"};var enumReg={phone:/^1[34578]{1}[0-9]{9}$/,pwd:/^[\u0021-\u007E]{4,16}$/};
function weixinConfig(){wx.config({debug:false,appId:"",timestamp:"",nonceStr:"",signature:"",jsApiList:["checkJsApi","closeWindow"]});}function countDown(){var a=2;
setInterval(b,1000);function b(){$("#seconds").html(a);if(a==0){wx.closeWindow();return;}a--;}}function login(){$(".J_login").click(function(){var b=$("#phone").val(),d=$("#password").val(),a=!$(".J_code").hasClass("hidden"),c=a?$("#code").val():"";
if(b==""||d==""){showMsg(enumMsg.phoneAndPwdNull);return false;}if(a&&c==""){showMsg(enumMsg.codeNull);return false;}if(!enumReg.phone.test(b)){showMsg(enumMsg.phoneIllegal);
return false;}if(d.length<4){showMsg(enumMsg.pwdError);return false;}if(a&&c.length<4){showMsg(enumMsg.codeError);return false;}$(".J_tips").addClass("invisible");
$(".J_mask").removeClass("hidden");$.ajax({url:$(this).attr("data-ajaxurl"),dataType:"json",timeout:10000,data:{tn:b,p:d,token:token,vid:$("#code").attr("data-vid"),vtx:c,vty:$("#code").attr("data-vty")},success:function(f){$(".J_mask").addClass("hidden");
var e=f.data;if((e.vmt&&e.vmt==1)){$(".J_code").removeClass("hidden");$("#code").attr("data-vty",e.vty[0]);$(".J_code img").trigger("click");}if(e.r){if(e.r=="1101"||a){$(".J_code").removeClass("hidden");
$(".J_code img").trigger("click");}if(enumStatusCode[e.r]){showMsg(enumStatusCode[e.r]);}else{bindFail();}return false;}else{bindSuccess(e.redirectUrl);
}},error:function(e,f){$(".J_mask").addClass("hidden");if(f=="timeout"){showMsg(enumStatusCode.timeout);}else{showMsg(enumStatusCode.unknow);}}});});if($(".J_bindOK").length&&!$(".J_bindOK").hasClass("hidden")){countDown();
}}function bindFail(){$(".J_loginContainer").addClass("hidden");$(".J_code").addClass("hidden");$("#code").val("");$(".J_bindOK").addClass("hidden");$(".J_bindError").removeClass("hidden");
}$(".J_rebind").bind("click",function(a){$(".J_bindError").addClass("hidden");$(".J_loginContainer").removeClass("hidden");});function bindSuccess(a){$(".J_loginContainer").addClass("hidden");
$(".J_bindError").addClass("hidden");$(".J_bindOK").removeClass("hidden");countDown();}function getVerCode(){$(".J_loading img").click(function(a){$("#code").val("");
$(this).addClass("hidden");$(this).siblings("i").removeClass("hidden");$.ajax({url:$(this).attr("data-ajaxurl"),dataType:"json",timeout:10000,success:function(e){var e=e.data;
var b=$(".J_loading img");var c="data:image/png;base64,"+e.vda;b.attr("src",c);$("#code").attr("data-vid",e.vid);b.siblings("i").addClass("hidden");b.removeClass("hidden");
},error:function(c,d){var b=$(".J_loading img");b.siblings("i").addClass("hidden");b.removeClass("hidden");if(d=="timeout"){showMsg(enumStatusCode.timeout);
}else{showMsg(enumStatusCode.unknow);}return false;}});});}function showMsg(a){if(a!=""){$(".J_tips").removeClass("invisible").html(a);}else{$(".J_tips").addClass("invisible").html(a);
}}function showTip(d){var c=$(".J_tipBox"),b=$(document).width(),e=c.width();c.find("p").html(d);var a=d.length*6;c.css("left",((b-e)/2-a)+"px").removeClass("hidden");
setTimeout(function(){c.addClass("hidden");c.find("p").html("");},1000);}showLog=true;isWin=$("body").attr("data-isWin")==="true";function gift(){if(!$("#scratcher").length){return;
}if(!supportsCanvas()){return;}var e="scratcher",d=getPicPath(),c=d+"/stratch-front.png",b=isWin?d+"/stratch-win.png":d+"/stratch-lose.png";scratcher=new Scratcher(e,b,c);
function a(f){scratcher.reset();scratcher.addEventListener("scratch",scratcherChanged);}scratcher.addEventListener("imagesloaded",a);}function scratcherChanged(b){var c=(this.fullAmount(32)*100)|0;
if(c>=20){if(showLog==true){var a=$("#Scratch_Holder").attr("data-ajaxUrl");$.post(a,{token:token,giftId:$("body").attr("data-giftId"),code:$("#codeName").html()},function(d){});
showLog=false;if(isWin){$(".J_codeContainer").removeClass("hidden");}}}}function supportsCanvas(){return !!document.createElement("canvas").getContext;
}function getPicPath(){var a=$("script[data-main]")[0],c=a.hasAttribute?a.src:a.getAttribute("src",4);var b=c.replace(/assets\/js\/.*/g,"pic");return b;
}function getUrlParam(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)");var c=window.location.search.substr(1).match(b);if(c!=null){return unescape(c[2]);
}return null;}function loadMore(){var a=$(".J_loadMore[data-ajaxUrl]");if(!a[0]){return;}a.on("click",function(){var e=a.attr("data-hasnext");if(e==0||e=="false"){return false;
}var d=parseInt(a.attr("data-curpage"));a.children(".J_load").addClass("hidden");a.children(".J_loading").removeClass("hidden");var b=a.attr("data-ajaxurl"),c={page:d+1,token:token,sign:getUrlParam("sign")};
$.post(b,c,function(l){var j=$(".J_mygiftList ul"),h="";console.log(l);var k=l.data.list;for(var g=0,f=k.length;g<f;g++){h+='<li>							<a href="'+k[g]["url"]+'">								<span class="name">'+k[g]["name"]+'</span>								<span class="date">有效期：'+k[g]["startDate"]+"至"+k[g]["endDate"]+'</span>								<div class="code">兑换码：<span>'+k[g]["code"]+"</span></div>							</a>						</li>";
}j.append(h);if(l.data.hasnext==0||l.data.hasnext=="false"){a.hide();}a.attr("data-hasnext",l.data.hasnext).attr("data-curpage",l.data.curpage);a.children(".J_load").removeClass("hidden");
a.children(".J_loading").addClass("hidden");},"json");});}