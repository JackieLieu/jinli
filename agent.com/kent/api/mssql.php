<?php class mssql implements db{private $sql;private $conn;public function __construct(){if(!extension_loaded('sqlsrv'))trigger_error('200|extension php_sqlsrv is required');}public function connect($config){$aes=new aes('szmykj@tonlo.com');$pwd=$aes->decrypt(base64_decode($config['pwd']));if('utf-8'==strtolower(CHARSET))$conn=sqlsrv_connect($config['host'].','.$config['port'],array('UID'=>$config['uid'],'PWD'=>$pwd,'Database'=>$config['db'],'MultipleActiveResultSets'=>true,'CharacterSet'=>'UTF-8'));else $conn=sqlsrv_connect($config['host'].','.$config['port'],array('UID'=>$config['uid'],'PWD'=>$pwd,'Database'=>$config['db'],'MultipleActiveResultSets'=>true));if($conn){$this->conn=$conn;}else{trigger_error('204|'.$this->get_error());}}public function query($sql,$param=array(),$dimension=2,$type=1){}public function select($table,$field,$where=array(),$order='',$offset='',$dimension=2,$type=1){}public function insert($table,$data,$auto=false){}public function update($table,$data,$where){}public function delete($table,$where){}public function execute($procedure,$param=array(),$dimension=2,$type=1){$result=array();$sql='{call '.$procedure.'(';if($param&&is_array($param)){$sql.=('?'.str_repeat(',?',count($param)-1));}$sql.=')}';$this->sql=$sql;$stmt=sqlsrv_query($this->conn,$sql,$param);if($stmt===false){trigger_error('201|'.$this->get_error().'.sql is:'.$this->sql);}$type=$this->get_result_type($type);switch($dimension){case 0:$result=true;$this->clear_more_result($stmt);break;case 1:$result=sqlsrv_fetch_array($stmt,$type);$this->clear_more_result($stmt);break;case 2:$result=$this->fetch_all_array($stmt,$type);$this->clear_more_result($stmt);break;case 3:$result=$this->fetch_all_result($stmt,$type);break;}sqlsrv_free_stmt($stmt);return $result;}private function get_result_type($type){switch($type){case 1:$type=2;break;case 2:$type=1;break;default:$type=3;}return $type;}private function fetch_all_array($stmt,$type){$result=array();while($row=sqlsrv_fetch_array($stmt,$type)){$result[]=$row;}return $result;}private function fetch_all_result($stmt,$type){$result=array();$result[]=$this->fetch_all_array($stmt,$type);while(sqlsrv_next_result($stmt)){$result[]=$this->fetch_all_array($stmt,$type);}return $result;}private function clear_more_result($stmt){while(sqlsrv_next_result($stmt)){sqlsrv_next_result($stmt);}}private function escape(&$data){if(is_array($data)){array_map(array($this,'escape'),$data);}else{if($data&&(!is_numeric($data))){$data=str_replace("'","''",$data);}}}private function get_error(){$result='';$errors=sqlsrv_errors();if(is_array($errors)){$errnum=$errors[0][1];$errmsg=$errors[0][2];$result=$errnum.$errmsg;}return $result;}public function get_sql(){return $this->sql;}public function get_version(){$result=sqlsrv_server_info($this->conn);return $result['SQLServerVersion'];}public function __destruct(){if($this->conn)sqlsrv_close($this->conn);}}?>