(function(a,g){a.incfile(["//underscore.js","//backbone.js"],function(){GNapp.init()},true);a.app("GNapp",function(){return{version:"1.0"}});var f={};f.routers={};f.views={};f.models={};f.collection={};f.domain={};var e=(location.search.indexOf("source=wap")>-1)?true:false,c=navigator.userAgent,d=false,b={android:/android/i.test(c),gionee:/Gionee/i.test(c)};d=b.android&&e==false;switch(location.host){case"dev.demo.gionee.com":f.domain.url="http://dev.demo.gionee.com/3g/app/backbone/";break;case"demo.3gtest.gionee.com":f.domain.url="http://demo.3gtest.gionee.com/3g/app/backbone/";break;case"3g.3gtest.gionee.com":f.domain.url="http://3g.3gtest.gionee.com/app/";break;default:f.domain.url="http://3g.gionee.com/app/"}GNapp.init=function(){f.models.app=Backbone.Model.extend({urlRoot:"/list_more",});f.collection.app=Backbone.Collection.extend({model:f.models.app,url:"/app/data?tid=",});f.routers.app=Backbone.Router.extend({routes:{"":"list",":nav":"list","category/:id":"showAppCateTmpl",},list:function(k){var m=this,l=k||"recommend",i=JSON.parse(g(".index_data").html());var j=new f.views.header({nav:l});j.showTopBanner();if(k=="category"){g("#J_appList").html(_.template(g("#J_appCateView").html()));return}this.gnapps=new f.collection.app({data:i[l].data});g("#J_appList").html(new f.views.appList({model:m.gnapps,nav:l}).render().el)},showAppCateTmpl:function(j){var i=this;new f.views.backNav();g("#J_appList").html('<div class="loading">\u6570\u636e\u52a0\u8f7d...</div>');this.gnapps=new f.collection.app();this.gnapps.url=f.domain.url+"list_more?type_id="+j+"&page=1";this.gnapps.fetch({success:function(){g("#J_appList").html(new f.views.appList({model:i.gnapps,nav:"list",typeId:j}).render().el)}})}});f.views.header=Backbone.View.extend({el:g("body"),template:_.template(g("#J_tabMenuView").html()),events:{"tap #app-tabs li":"changeTab",},initialize:function(){this.render()},render:function(){g("#J_tabMenu").html(this.template());this.selectMenuItem(this.options.nav)},showTopBanner:function(){g("#header").html(_.template(g("#J_topBannerView").html()))},selectMenuItem:function(i){g("#app-tabs li").removeClass("actived");if(i){g("#app-tabs li[data-target="+i+"]").addClass("actived")}},changeTab:function(i){var j=g(i.target);var k=j.attr("data-link");h.navigate(k,true);return false}});f.views.backNav=Backbone.View.extend({el:g("#header"),template:_.template(g("#J_backNavView").html()),initialize:function(){this.render()},render:function(){g(this.el).html(this.template({cateName:""}));this.hideTabMenu();return this},hideTabMenu:function(){g("#app-tabs").remove()},hideAppList:function(){g("#J_appList").remove()}});f.views.appList=Backbone.View.extend({tagName:"ul",events:{"tap .add-btn":"addAppIcon","tap .open-btn":"openAppLink","tap .list-more":"showAppMore",},initialize:function(){this.model.bind("reset",this.render,this)},render:function(){var k=[],j=0;if(d){k=this.getLocalData()}_.each(this.model.models,function(i){if(this.options.nav=="list"){g("#J_backNavTitle").text(i.get("data").cateName)}_.each(i.toJSON().data.list,function(l){l.status=d?k.indexOf(l.id)>-1?1:0:1;this.$el.append(new f.views.appItem({model:i,index:j++}).render().el)},this);g(".list-more").remove();if(i.get("data").hasnext==true){this.$el.append('<li class="item list-more">\u52a0\u8f7d\u66f4\u591a</li>')}},this);return this},getLocalData:function(){try{localData=JSON.parse(window.prompt("gn://GNNavSiteData/select",""))}catch(i){localData=0}return localData.data},addAppIcon:function(i){var k=g(i.target),j=k.attr("data-addUrl");var l=window.prompt("gn://GNNavSiteData/insert",j);if(b.android&&e==false){if(JSON.parse(l).result=="0"){window.prompt("gn://GNNavSiteData/tips","\u6dfb\u52a0\u6210\u529f");k.html("\u6253\u5f00").removeClass("add-btn").addClass("open-btn lock");setTimeout(function(){k.removeClass("lock")},50)}else{console.log("Gionee.views.appList:addAppIcon get interface data error.")}}},openAppLink:function(i){var l=g(i.target),j=l.attr("data-link"),k=l.attr("data-addUrl");if(!l.hasClass("lock")&&k!=null){window.location.href=j}},showAppMore:function(j){var m=j.target,l=this;var k=this.model.models;var i=k.length;if(k[0].get("data").hasnext==false){this.$el.find(".list-more").remove()}if(this.options.nav=="list"){this.model.url=f.domain.url+this.options.nav+"_more?type_id="+this.options.typeId+"&page="+(+k[0].get("data").curpage+1)}else{this.model.url=f.domain.url+this.options.nav+"_more?page="+(+k[0].get("data").curpage+1)}this.model.fetch();this.loadStatus();if(g(m).hasClass("locked")||g(m).parent().hasClass("locked")){return}},loadStatus:function(){this.$el.find(".list-more").addClass("locked");this.$el.find(".list-more").html("\u6b63\u5728\u52a0\u8f7d\u6570\u636e...");return this}});f.views.appItem=Backbone.View.extend({tagName:"li",className:"item",template:_.template(g("#J_itemView").html()),initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this)},render:function(){this.$el.append(this.template(this.model.toJSON().data.list[this.options.index]));return this},close:function(){this.$el.unbind();this.$el.remove()}});f.views.app=Backbone.View.extend({});var h=new f.routers.app();Backbone.history.start()}})(ICAT,Zepto);
