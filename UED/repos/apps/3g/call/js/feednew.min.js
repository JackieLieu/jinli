/*! call 2015-07-09 */
!function(){function a(a){$(".feed-tips-error")[0]?$("#feed-tips-error span").html(a):($("#feed-new-list").append('<div class="feed-tips-error"><i></i><span>'+a+"</span></div>"),i.refresh(),i.scrollToElement("#feed-new-list div:last-child"))}function b(){l.init()}function c(){j=document.getElementById("pullDown"),k=j.offsetHeight,i=new iScroll("feed-new-wrapper",{useTransition:!0,topOffset:k,onRefresh:function(){j.className.match("loading")&&(j.className="",j.querySelector(".pullDownLabel").innerHTML="加载完成")},onScrollMove:function(){this.y>5&&!j.className.match("flip")?(j.className="flip",j.querySelector(".pullDownLabel").innerHTML="下拉加载聊天记录",this.minScrollY=0):this.y<5&&j.className.match("flip")&&(j.className="",j.querySelector(".pullDownLabel").innerHTML="松开停止加载聊天记录",this.minScrollY=-k)},onScrollEnd:function(){j.className.match("flip")&&(j.className="loading",j.querySelector(".pullDownLabel").innerHTML="加载中，请稍候",b())}}),setTimeout(function(){document.getElementById("feed-new-wrapper").style.left="0"},100)}var d=!1,e=+new Date,f=0,g=1,h=1;$("#js-feed-txt").on("keyup",function(){$(this).val().length>0?$("#js-feed-btn").addClass("inp-act"):$(this).val().length>250?(a("太多啦，先把这些发给我吧"),$("#js-feed-btn").removeClass("inp-act")):$("#js-feed-btn").removeClass("inp-act")}),$("#js-feed-frm").on("submit",function(b){b.preventDefault();var c=$(this).serialize();d=+new Date-e>3e3?!1:d,$("#js-feed-btn").hasClass("inp-act")&&(d?a("发送太频繁啦，间隔时间为3秒哦"):$.ajax({url:"http://3g.3gtest.gionee.com/front/feedback/msgsend",type:"get",data:c,dataType:"jsonp",success:function(b){if($(".feed-tips-error").remove(),b.success){++f;var c=new Date,g=c.getHours()<10?"0"+c.getHours():c.getHours(),h=c.getMinutes()<10?"0"+c.getMinutes():c.getMinutes();sendTime=g+":"+h,l.renderHtml(+new Date-e>6e4||1==f?{wrap:$("#feed-new-list"),line:!0,type:1,time:sendTime,text:$("#js-feed-txt").val(),page:0}:{wrap:$("#feed-new-list"),line:!1,type:1,time:sendTime,text:$("#js-feed-txt").val(),page:0}),""!=b.data&&l.renderHtml({wrap:$("#feed-new-list"),line:!1,type:2,time:sendTime,text:b.data.replayMsg,page:0}),$("#js-feed-txt").val(""),$("#js-feed-btn").removeClass("inp-act"),d=!0,e=+new Date,i.refresh(),i.y<-30&&i.scrollToElement("#feed-new-list div:last-child")}else a(b.msg)},error:function(){$("#js-feed-btn").hasClass("inp-act")&&a("发送失败")}}))});var i,j,k,l={init:function(a){var b=$("#js-feed-frm").serialize();return g>h?void setTimeout(function(){i.refresh()},2e3):void $.ajax({url:"http://3g.3gtest.gionee.com/front/feedback/msglist",type:"get",data:b+"&page="+g,dataType:"jsonp",success:function(b){if($("#pullDown").removeClass("feed-tips-error"),b.success){var c,d,e=b.data.list;$.each(e,function(a,e){e.time==c&&e.flag==d?l.renderHtml({wrap:$("#feed-new-list"),line:!1,type:e.flag,time:c,text:e.content,page:b.data.cur_page}):(c=e.time,d=e.type,l.renderHtml({wrap:$("#feed-new-list"),line:!0,type:e.flag,time:c,text:e.content,page:b.data.cur_page}))}),g=b.data.cur_page,h=b.data.max_page,g++,i.refresh(),1==a&&(i.refresh(),i.scrollToElement("#feed-new-list div:last-child",0))}},error:function(){1!=a&&($("#pullDown").addClass("feed-tips-error"),$("#pullDown .pullDownLabel").html("加载失败，请检查网络"))}})},renderHtml:function(a){var b;1==a.type?sname="sender":sname="receiver",b=1==a.line&&""!=a.time?'				<div class="date-line">					<span class="time">'+a.time+'</span>				</div>				<div class="'+sname+'-line">					<p class="'+sname+'">'+a.text+"</p>				</div>":'<div class="'+sname+'-line">					<p class="'+sname+'">'+a.text+"</p>				</div>",a.page==g&&g>1?a.page>1?$("#feed-new-list div").first().before(b):$("#feed-new-list div").last().after(b):$("#feed-new-list").append(b)},contact:function(){var a=$("#js-contact-frm .inp-btn-wrap");$("#inp-mobile,#inp-qq,#inp-email").on("input",function(){$(this).val().length>0&&a.addClass("inp-btn-act")}),$("#js-contact-frm").on("submit",function(b){b.preventDefault();var c=$(this);a.hasClass("inp-btn-act")&&$.ajax({url:"/front/feedback/contact",type:"post",data:c.serialize(),dataType:"json",success:function(a){a.success&&setTimeout(function(){window.history.go(-1)},1500),$(".toast-wrap").show(),$(".toast-wrap p").html(a.msg),setTimeout(function(){$(".toast-wrap").hide(),$(".toast-wrap p").html("")},1e3)}})})}};$(window).on("resize",function(){i.refresh(),i.scrollToElement("#feed-new-list div:last-child",0)}),$(function(){$("#feed-new-wrapper")[0]&&($(document).on("touchmove",function(a){a.preventDefault()}),c(),l.init(1)),l.contact()})}($);