$(function(){var c={file:luckDrawData.list};c.data={};c.data["1"]=["prizeName","probability","leastDate","maxQuantity","lotteryNumber","index","cId"];c.data["2"]=["prizeName","probability","leastDate","maxQuantity","lotteryNumber","validityPeriod","aSecuritiesTitle","amount","index","cId"];
c.data["3"]=["prizeName","probability","leastDate","maxQuantity","lotteryNumber","integralTitle","amount","index","cId"];c.data["0"]=["prizeName","productType","index","cId"];
c.type="";var a=function(e){$("#alert").dialog("open");$("#alert").find('[name="msg"]').html(e);};var b={title:function(e){if(!Validata.empty(e)){a("请输入活动名称");
return;}return true;},start_time:function(e){if(!Validata.empty(e)){a("请输入开始时间");return;}return true;},end_time:function(e){if(!Validata.empty(e)){a("请输入结束时间");
return;}return true;},img:function(e){return true;},point:function(e){if(!Validata.empty(e)){a("请输入消耗积分");return;}if(!Validata.number(e)){a("消耗积分应为正整数");
return;}return true;},validityPeriod:function(e){if(!Validata.empty(e)){a("请输入有效期");return;}if(!Validata.number(e)){a("有效期应为正整数");return;}return true;},integralNumber:function(e){if(!Validata.empty(e)){a("请输入积分数量");
return;}if(!Validata.number(e)){a("积分数量应为正整数");return;}return true;},prizeName:function(e){if(!Validata.empty(e)){a("请输入奖品名称");return;}return true;},poster:function(e){return true;
},probability:function(e){if(!Validata.empty(e)){a("请输入中奖概率数量");return;}if(!Validata.number(e)){a("中奖概率应为正整数");return;}return true;},leastDate:function(e){if(!Validata.empty(e)){a("请输入发放中最小间隔");
return;}if(!Validata.number(e)){a("发放中最小间隔应为正整数");return;}return true;},maxQuantity:function(e){if(!Validata.empty(e)){a("请输入最大数量");return;}if(!Validata.number(e)){a("最大数量应为正整数");
return;}return true;},lotteryNumber:function(e){if(!Validata.empty(e)){a("请输入抽奖次数");return;}if(!Validata.number(e)){a("抽奖次数应为正整数");return;}return true;
}};$("#start_time").datetimepicker();$("#start_time").datepicker("option","dateFormat","yy-mm-dd");$("#end_time").datetimepicker();$("#end_time").datepicker("option","dateFormat","yy-mm-dd");
var d=function(g,e){var h='#prizeForm td[data-index="'+e+'"] table';var f=new Form(h);f.setHtml(g);$(h).find('[name="bigPoster"]').attr("src",attachPath+g.bigPoster);
if(g.type=="least"){if(g.leastType=="1"){$(h).find('[name="prizeName"]').html("不中奖");}else{$(h).find('[name="prizeName"]').html("积分");}$(h).find('[name="probability"]').parent().hide();
$(h).find('[name="maxQuantity"]').parent().hide();}else{$(h).find('[name="probability"]').parent().show();$(h).find('[name="maxQuantity"]').parent().show();
}$(h).show();$("#prizeForm").find('td[data-index="'+e+'"] [name="add"]').hide();};$("#prizeAllocation").dialog({autoOpen:false,width:650,title:"配置奖品"});
$("#alert").dialog({autoOpen:false,title:"警告",buttons:{"确定":function(){$(this).dialog("close");}}});$('#prizeAllocation [name="type"]').change(function(){var e=$(this).val(),g=c.data[e].length;
$("#prizeAllocation *[data-name]").hide();for(var f=0;f<g;f++){$('#prizeAllocation [data-name="'+c.data[e][f]+'"]').show();}if(e=="least"){$("#leastType").trigger("change");
}c.type=e;$('[data-name="poster'+c.index+'"]').show();});$('#prizeAllocation [name="ok"]').click(function(){var g=new Form("#prizeAllocation"),n=g.getVal(),k=c.data[c.type],h=k.length,f,m=c.index,j=true,e={};
for(var l=0;l<h;l++){f=k[l];if(b[f]){if(!b[f](n[f])){j=false;return;}}e[f]=n[f];}if(!j){return;}e.bigPoster=$('[data-name="poster'+m+'"]').find('[name="bigPoster"]').val();
e.smallPoster=$('[data-name="poster'+m+'"]').find('[name="smallPoster"]').val();if(!(b.poster(e.bigPoster)||b.poster(e.smallPoster))){return;}e.type=c.type;
if(e.type=="0"){e.leastType=c.leastType;if(e.leastType!="0"){e.integralNumber=$('input[name="integralNumber"]').val();if(!b.integralNumber(e.integralNumber)){return;
}}}e.index=m;c.file[m-1]=e;$("#prizeAllocation").dialog("close");console.log(JSON.stringify(c.file[m-1]));d(e,m);});$("#prizeForm").on("click",'input[name="add"]',function(){c.index=$(this).parent().attr("data-index");
var e=new Form("#prizeAllocation");e.close();$("#prizeAllocation").dialog("open");$('#prizeAllocation [name="type"]').trigger("change");});$("#submit").click(function(){var h=new Form("#form"),g=h.getVal(),f=true;
console.log(JSON.stringify(g));if(c.file.length<7){a("配置奖品未完程请继续添加");return;}for(var e in g){if(b[e]&&e!="probability"&&e!="maxQuantity"){if(!b[e](g[e])){f=false;
return;}}}if(!f){return;}g.token=token;g.list=c.file;g.descript=editor.html();g.status=$("#status option:selected").val();g.lotteryMode=$("#lotteryMode option:selected").val();
console.log(JSON.stringify(g));$.post(actionUrl,g,function(i){if(!i.success){a(i.msg||"添加失败");return;}a("添加成功");window.location.href=redirectUrl;});});
$("#prizeForm").on("click",'input[name="update"]',function(){c.index=$(this).parents("td[data-index]").attr("data-index");var g=$('#prizeAllocation select[name="type"]'),h=$("#leastType"),e=c.file[c.index-1];
var f=new Form("#prizeAllocation");f.setVal(e,["type","leastType"]);g.trigger("change");h.find("option").each(function(){if($(this).attr("value")==e.leastType){$(this).prop("selected","selected");
}});h.trigger("change");$("#prizeAllocation").dialog("open");});$("#leastType").change(function(){var e=$(this).val();if(e=="1"){$('input[name="integralNumber"]').show();
$("#integralNumberTitle").show();}else{$('input[name="integralNumber"]').hide();$("#integralNumberTitle").hide();}c.leastType=e;});$("#lotteryMode").change(function(){var e=$(this).val();
$('[name="lotteryMode"]').hide();$('[name="lotteryMode"]:eq('+(e-1)+")").show();});$("#lotteryMode").trigger("change");(function(){var f=c.file.length,g;
if(!f){return;}for(var e=0;e<f;e++){d(c.file[e],c.file[e].index);}}());});