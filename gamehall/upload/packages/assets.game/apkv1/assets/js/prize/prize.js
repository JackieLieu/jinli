var lottery={index:-1,count:0,timer:0,speed:180,times:0,cycle:30,prize:-1,click:false,callBack:function(){},init:function(a){if($("#"+a).find("li.prize-unit").length>0){$lottery=$("#"+a);
$units=$lottery.find(".prize-unit");this.obj=$lottery;this.count=$units.length;}},roll:function(){var a=this.index;var c=this.count;var b=this.obj;$(b).find("#prize-grid"+a).removeClass("active");
a+=1;if(a>c-1){a=0;}$(b).find("#prize-grid"+a).addClass("active");this.index=a;return false;},setPrize:function(a){this.prize=a;},getPrize:function(){if(this.prize==-1){return undefined;
}else{return this.prize;}},stop:function(){this.callBack();},reset:function(){clearTimeout(this.timer);$("#prize-btn").removeClass("prize-btn-active");
$("#prize_wrap").find("#prize-grid"+this.index).removeClass("active");this.click=false;this.speed=180;this.index=-1;this.prize=-1;}};function roll(){lottery.times+=1;
lottery.roll();if(lottery.times>lottery.cycle+10&&lottery.prize==lottery.index){clearTimeout(lottery.timer);lottery.stop();lottery.prize=-1;lottery.times=0;
click=false;}else{if(lottery.times==lottery.cycle){if(lottery.getPrize()==undefined){lottery.cycle+=10;}}lottery.timer=setTimeout(roll,lottery.speed);}return false;
}var turnplate={prize:prize||[],colors:["#f9f5cf","#f9e4af","#f9f5cf","#f9e4af","#f9f5cf","#f9e4af","#f9f5cf","#f9e4af"],x:211,y:211,outsideRadius:192,textRadius:170,insideRadius:90,startAngle:0,bRotate:false,};
var rotateStart=function(){$("#wheelcanvas").stopRotate();$("#wheelcanvas").rotate({angle:0,animateTo:1800,duration:10000});};var rotateTimeOut=function(){if(turnplate.bRotate){turnplate.bRotate=false;
}$("#wheelcanvas").stopRotate();};var rotateFn=function(a,d){var c=(a-2)*(360/turnplate.prize.length)-(360/(turnplate.prize.length*2));if(c<270){c=270-c;
}else{c=360-c+270;}var b=$("#wheelcanvas").getRotateAngle();$("#wheelcanvas").rotate({angle:b,animateTo:c+1800,duration:8000,callback:function(){turnplate.bRotate=!turnplate.bRotate;
d();}});};var getPixelRatio=function(a){var b=a.backingStorePixelRatio||a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1;
return(window.devicePixelRatio||1)/b;};function drawRouletteWheel(){var b=document.getElementById("wheelcanvas");if(!b){return;}if(b.getContext){var a=Math.PI/(turnplate.prize.length/2);
var m=b.getContext("2d");var h=getPixelRatio(m);m.clearRect(0,0,(turnplate.x*2)*h,(turnplate.y*2)*h);m.strokeStyle="#fff9e3";m.font="15px Microsoft YaHei";
for(var g=0;g<turnplate.prize.length;g++){var d=turnplate.startAngle+(g-2)*a;m.fillStyle="#fff9e3";m.beginPath();m.arc(turnplate.x,turnplate.y,(turnplate.outsideRadius),d,d+a,false);
m.arc(turnplate.x,turnplate.y,turnplate.insideRadius-30,d+a,d,true);m.stroke();m.fill();m.closePath();m.fillStyle=turnplate.colors[g];m.beginPath();m.arc(turnplate.x,turnplate.y,(turnplate.outsideRadius-33),d,d+a,false);
m.arc(turnplate.x,turnplate.y,turnplate.insideRadius-30,d+a,d,true);m.stroke();m.fill();m.save();m.fillStyle="#a45d00";var l=turnplate.prize[g];var k=17;
m.translate(211+Math.cos(d+a/2)*turnplate.textRadius,211+Math.sin(d+a/2)*turnplate.textRadius);m.rotate(d+a/2+Math.PI/2);if(l.length>6){l=l.substring(0,6)+"||"+l.substring(6);
var c=l.split("||");for(var e=0;e<c.length;e++){m.fillText(c[e],-m.measureText(c[e]).width/2,e*k);}}else{m.fillText(l,-m.measureText(l).width/2,0);}var f=document.getElementById("img"+(g+1));
m.drawImage(f,-(35*h),15*h,70*h,70*h);m.restore();}$("#wheelcanvas").css("width","100%");$("#wheelcanvas").css("height","auto");}}(function(){var c={networkError:"网络异常，请稍候重试",notLogin:"未登录，请先登录",underPoints:"您的积分不足",nameError:"收货人不能为空",phoneError:"请输入合法的联系电话",addressError:"收货地址不能为空",postSuccess:"提交成功",timeOut:"请求超时",postError:"请求异常，请刷新重试"};
var b={network:"gamehall.hasnetwork",alert:"gamehall.alert",logout:"gamehall.clearlogin",finish:"gamehall.finish",islogin:"gamehall.islogin",getPoint:"gamehall.daily.task",login:"gamehall.account",statis:"gamehall.sendstatis",boradcast:"gamehall.money.change",getServerId:"gamehall.getserverid",};
var a={intervalId:null,getUrlParam:function(d){var e=new RegExp("(^|&)"+d+"=([^&]*)(&|$)");var f=window.location.search.substr(1).match(e);if(f!=null){return unescape(f[2]);
}return"";},getServerId:function(){var d=a.getUrlParam("sp").split("_")[1];var e="";if(a.compareVersion(d,"1.5.7")){e=a.getValueAction(b.getServerId,{url:location.href}).serverId;
}return e;},compareVersion:function(f,e){if(f.indexOf(e)>-1){return true;}var h=f.split("."),j=e.split(".");var d=Math.max(h.length,j.length);for(var g=0;
g<d;g++){if(h[g]===undefined){return false;}if(j[g]===undefined){return true;}if(h[g]>j[g]){return true;}else{if(h[g]<j[g]){return false;}}}return false;
},initPrizeScroll:function(){lottery.init("prize_wrap");drawRouletteWheel();var p=location.search,g=$("#acoin").attr("data-infpage").split(",");if(g.length>2){aCoinUrl=g[1]+p;
$("#acoin").attr("data-infpage",g[0]+","+aCoinUrl);}var m=a.getUrlParam("uname"),f=a.getUrlParam("puuid"),d=a.getUrlParam("sp"),e=d.split("_"),j=e[e.length-1],h=$("#prize-btn").length?$("#prize-btn").attr("data-ajaxUrl"):$(".J_pointer").attr("data-ajaxUrl");
$(".btn-points").click(function(){a.onEventAction(b.getPoint,{});});$("#prize-btn").click(function(){if(lottery.click||$(this).hasClass("prize-btn-active")){return;
}var r=function(){roll();lottery.click=true;$("#prize-btn").addClass("prize-btn-active");};var q=function(t,s,u){lottery.setPrize(parseInt(t.prizeIndex,10)-1);
lottery.callBack=function(){a.getBillboard();$("#prize-totalPoints").html(t.totalPoints);o(s);a.onEventAction(b.statis,u);};};l(r,q);});$("body").on("click",".J_pointer",function(r){if(turnplate.bRotate||$(this).hasClass("prize-btn-active")){return;
}var s=function(){rotateStart();turnplate.bRotate=!turnplate.bRotate;$(".J_pointer").addClass("prize-btn-active");};var q=function(w,u,x){var v=parseInt(w.prizeIndex,10);
var t=function(){a.getBillboard();$("#prize-totalPoints").html(w.totalPoints);o(u);a.onEventAction(b.statis,x);};rotateFn(v,t);};l(s,q);});function i(){if($("#prize-btn").length){lottery.reset();
}else{rotateTimeOut();$(".J_pointer").removeClass("prize-btn-active");}}function l(u,q){var s=$("#prize-totalPoints"),r=parseInt($("#prize-consumePoints").html(),10);
if(parseInt(s.html(),10)<r){a.onEventAction(b.alert,{alertStr:c.underPoints});$("#prize-btn,.J_pointer").removeClass("prize-btn-active");return;}u();var t={action:"lottery",object:"lottery"+prizeId};
a.onEventAction(b.statis,t);$.ajax({type:"POST",url:h,dataType:"json",timeout:5000,data:{token:token,puuid:f,uname:m,prizeId:prizeId,serverId:a.getServerId(),imei:j,sp:d},success:function(x){if(!x||(typeof x=="string")||(!x.success)){i();
var z=c.postError;if(x&&x.msg){z=x.msg;}a.onEventAction(b.alert,{alertStr:z});return;}var y=x.data;if(y.isLogin!=undefined&&y.isLogin==false){i();a.onEventAction(b.finish,{});
a.onEventAction(b.logout,{});a.onEventAction(b.login,{});return;}if(y.underPoints&&y.underPoints==false){i();a.onEventAction(b.alert,{alertStr:c.underPoints});
return;}if(y.prizeType!=undefined){a.onEventAction(b.boradcast,{});var A={action:"visit",object:"lotterypop",intersrc:"prize"+y.configId},v;if(y.prizeType==0){A={action:"visit",object:"lotterypop",intersrc:"lose"};
v=".J_noPrize";}else{if(y.prizeType==1){v=".J_entity";$("#name").val(y.receivingName);$("#phone").val(y.receivingPhone);$("#address").val(y.receivingAddress);
$("#submit").attr("data-ticket",y.ticket);$("#submit").attr("data-logId",y.logId);}else{if(y.prizeType==2){v=".J_acoin";$("#indate").html(y.indate+"天");
}else{if(y.prizeType==3){v=".J_points";}}}}var w=$(v);w.find("img").attr("src",y.prizeImg);w.find("#prizeName").html(y.prizeName);q(y,w,A);}},error:function(w,x){var v=c.networkError;
if(x=="timeout"){v=c.timeOut;}i();a.onEventAction(b.alert,{alertStr:c.networkError});}});}$("body").delegate("#close","click",function(){var q=$(this).parent("div").parent("div");
k(q);i();});$("body").delegate("#acoin","click",function(){var q=$(this).parent("div").parent("div");k(q);i();});$("body").delegate("#continue","click",function(){var q=$(this).parent("div").parent("div");
k(q);setTimeout(function(){i();if($("#prize-btn").length){$("#prize-btn").trigger("click");}else{$(".J_pointer").trigger("click");}},300);});$("body").delegate("#submit","click",function(){var t=$("#name").val().trim(),r=$("#phone").val().trim(),q=$("#address").val().trim(),w=$(this).attr("data-ajaxUrl"),v=$(this).attr("data-ticket"),s=$(this).attr("data-logId");
if($.isEmptyObject(t)){a.onEventAction(b.alert,{alertStr:c.nameError});return;}var u=/^1[34578]{1}[0-9]{9}$/;if(!u.test(r)){a.onEventAction(b.alert,{alertStr:c.phoneError});
return;}if($.isEmptyObject(q)){a.onEventAction(b.alert,{alertStr:c.addressError});return;}$(this).addClass("hidden");$(".loading-btn").removeClass("hidden");
$.ajax({type:"POST",url:w,dataType:"json",data:{token:token,name:t,phone:r,address:q,ticket:v,logId:s},success:function(y){if(y.success){a.onEventAction(b.alert,{alertStr:c.postSuccess});
var x=$(".J_entity");k(x);}else{a.onEventAction(b.alert,{alertStr:c.networkError});}i();$("#submit").removeClass("hidden");$(".loading-btn").addClass("hidden");
},error:function(){i();a.onEventAction(b.alert,{alertStr:c.networkError});$("#submit").removeClass("hidden");$(".loading-btn").addClass("hidden");}});});
function n(q){q.preventDefault();}function o(q){$("body").bind("touchmove",n,false);var r=document.body.scrollTop+"px";q.show().animate({display:"block",bottom:"0px",},300,function(){$(".J_dialog").removeClass("invisible");
});}function k(r){$("body").unbind("touchmove");var q=r.height();r.animate({display:"block",bottom:-q,},300,function(){$(this).hide();$(".J_dialog").addClass("invisible");
});}},getBillboard:function(){var d=$("#rolling").attr("data-ajaxUrl");$.ajax({type:"POST",url:d,dataType:"json",data:{prizeId:prizeId,token:token},success:function(j){var h=j.data.list;
if(h&&h.length>0){var g="<ul>";for(var f=0,e=h.length;f<e;f++){g+='<li class="roll">'+h[f]+"</li>";}g+="</ul>";$("#rolling").html(g);$("#rolling").removeClass("invisible");
a.marquee();}}});},marquee:function(){var f=$("#rolling");var d=500;var e=3500;function g(){$(f).find("ul:first").animate({marginTop:"-32px"},d,function(){$(this).css({marginTop:"0px"}).find("li:first").appendTo(this);
});}if(a.intervalId!=null){clearInterval(a.intervalId);}a.intervalId=setInterval(g,e);},setDialogHeight:function(){$(".J_dialog").height($(document).height());
var f=[".J_noPrize",".J_points",".J_acoin",".J_entity"];for(var e=0,d=f.length;e<d;e++){var g=$(f[e]);g.css("bottom",-g.height());g.removeClass("invisible").hide();
}},openPageByViewType:function(){$("body").delegate("[data-infpage]","click",function(){var g=$(this).attr("data-infpage").split(",");if(!(window.gamehall||navigator.gamehall)){location.href=g[1];
return;}var k=$(this).attr("data-type"),h=$(this).attr("data-viewType"),d=$(this).attr("data-source")||"",e=g[1],l=g[0];var j={};j.args={},j.type="list";
j.args.newArgs={viewType:h,param:{url:e,title:l,source:d}};var f=errCal=function(){},i=window.gamehall?window.gamehall:navigator.gamehall;i.startlistactivity(f,errCal,JSON.stringify(j.args));
});},onEventAction:function(f,e){if(window.gamehall){var d=window.gamehall.onEvent(f,JSON.stringify(e));}else{if(f=="gamehall.alert"){alert(e.alertStr);
}}},getValueAction:function(f,e){if(window.gamehall){var d=window.gamehall.getValue(f,JSON.stringify(e));d=JSON.parse(d);return d;}},checkLoginStatus:function(){if(typeof isLogin=="undefined"){return;
}if(isLogin!=undefined&&(isLogin=="false"||isLogin==false)){this.onEventAction(b.finish,{});this.onEventAction(b.logout,{});this.onEventAction(b.login,{});
}},init:function(){this.checkLoginStatus();this.setDialogHeight();this.initPrizeScroll();this.getBillboard();this.openPageByViewType();}};window.onload=function(){var f=$(".dial-container .imgs img"),e=f.length,d=0;
if(!$(".dial-container").length){a.init();}f.each(function(){if(this.complete){d++;if(d==e){a.init();}return;}$(this).load(function(){d++;if(d==e){a.init();
}});});};})();