<?php echo $this->render("layout/header.phtml");?>
    <div class="nav">
        <ul class="cc">
            <li><a href="<?php echo $listUrl;?>">发放活动</a></li>
            <li class="current"><a href="<?php echo $addUrl;?>">添加活动</a></li>
            <li><a href="<?php echo $ticketDetailUrl;?>">代金券明细列表</a></li>
            <li><a href="<?php echo $moneyDetailUrl;?>">A币交易明细</a></li>
            <li><a href="<?php echo $detailUrl;?>">A券说明</a></li>
            <li><a href="<?php echo $gameVoucherDetailUrl;?>">游戏券说明</a></li>
            <li><a href="<?php echo $sendTicketUrl;?>">手动赠送</a></li>
        </ul>
    </div>
    <style>
        .notLoginClient {
            display: none;
        }
        .cons {
            display: none;
        }
        .myList>li {
            margin: 5px 0;
        }
        .sortInput {
            width: 80px;
        }
        .item {
            padding: 10px;
            border-bottom: 1px solid #CCCCCC;
        }
        .label {
            display: inline-block;
            width: 50px;
        }
        .deleteItem {
            float: right;
            margin-right: 200px;
        }
        #addItem {
            float: right;
            margin-right: 100px;
        }
    </style>
    <div class="table_list">
        <form action="<?=$addPostUrl?>" method="post" id="add_form">
            <input type="hidden" name="token" value="<?=$token ?>">
            <table style="width: 100%">
                <tr class="hd">
                    <td colspan="2">添加活动</td>
                </tr>
                <tr class="ct">
                    <td>活动名称</td>
                    <td><input type="text" name="title" class="input wc"></td>
                </tr>
                <tr class="ct">
                    <td>生效时间</td>
                    <td>
                        <input type="text" name="hd_start_time" class="time">
                        至
                        <input type="text" name="hd_end_time" class="time">
                    </td>
                </tr>
                <tr class="ct">
                    <td>赠送场景</td>
                    <td>
                        <select name="htype" id="htype">
                            <?php foreach ($htype as $key => $value) { ?>
                                <option value="<?=$key?>"><?php echo $value?></option>
                            <?php } ?>
                        </select>
                        <span style="color: red">变更该项下面的配置内容会重置</span>
                        <br/>
                    <span id="sdk_ver_info" style="display:none;">
                         只有接入3.0.1.i及以上版本SDK的联运游戏支持该项活动。
    				</span>
                    </td>
                </tr>
                <tr class="ct">
                    <td>代金券类型</td>
                    <td>
                        <select name="ticket_type" id="ticketType">
                            <?php foreach ($ticketType as $key => $value) { ?>
                                <option value="<?php echo $key?>"><?php echo $value?></option>
                            <?php } ?>
                        </select>
                        <span style="color: red">变更该项下面的配置内容会重置</span>
                    </td>
                </tr>
                <tr class="ct">
                    <td>状态</td>
                    <td>
                        <select name="status" id="status">
                            <option value="1">开启</option>
                            <option value="0">关闭</option>
                        </select>
                    </td>
                </tr>
                <tr class="ct">
                    <td>参与用户</td>
                    <td>
                        <span>
                            <label>
                                <input type="radio" name="hd_object" value="1" checked>
                                全部
                            </label>
                        </span>
                        <span>
                            <label>
                                <input type="radio" name="hd_object" value="2">
                                定向
                            </label>
                        </span>
                    </td>
                </tr>
                <tr class="ct" id="hd_object_addition_info" style="display:none;">
                    <td>用户帐号ID</td>
                    <td>
                        格式：用户UUID1;用户UUID2;... <br/>
                        <span>
                            <label>
                                <input type="text" name="hd_object_addition_info"  class="input wc"/>
                            </label>
                        </span>
                    </td>
                </tr>
                <tr class="notLoginClient ct" id="game_object">
                    <td>参与游戏</td>
                    <td>
                        <span>
                            <label>
                                <input  type="radio" name="game_object" value="1" checked>
                                全部
                            </label>
                        </span>
                        <span>
                            <label>
                                <input  type="radio" name="game_object" value="2">
                                定向专题
                            </label>
                        </span>
                        <span>
                            <label>
                                <input type="radio" name="game_object" value="3">
                                定向游戏
                            </label>
                        </span>
                        <span>
                            <label>
                                <input type="radio" name="game_object" value="4">
                                排除游戏
                            </label>
                        </span>
                        <br/>
                        <br/>
                        <span class="payment_game_obj_tips" style="color:red; display: none;">
                            赠送场景:选择[充值返利], 参与游戏中[全部选项]默认包含游戏大厅在内。
                        </span>
                    </td>
                </tr>
                <tr class="notLoginClient ct" id="subject_id" style="display:none;">
                    <td>专题ID</td>
                    <td>
                        <span>
                            <label>
                                <input type="text" name="subject_id"  class="input wc">
                            </label>
                        </span>
                    </td>
                </tr>
                <tr class=" ct" id="game_object_addition_info" style="display:none;">
                    <td>游戏列表</td>
                    <td>
                        <span>格式：游戏ID1;游戏ID2;...</span>
                        <br/>
                        <span>
                            <label>
                                <input type="text" name="game_object_addition_info" class="input wc">
                            </label>
                        </span>
                    </td>
                </tr>
                <tr class="ct">
                    <td>赠送条件</td>
                    <td>
                        <div class="notCons">
                            <span>
                                <label>
                                    <input type="radio" name="condition_type" value="1" id="firstLogin" checked>
                                    首次登录
                                </label>
                            </span>
                            <span class="notLoginClient">
                                <label>
                                    <input type="radio" name="condition_type" value="2">
                                    每日登录
                                </label>
                            </span>
                        </div>

                        <div class="cons myList">
                            <!-- <span><label><input type="radio" name="condition_type3" value="1" checked>首次消费</label></span> -->
                            <!-- <span><label><input type="radio" name="condition_type3" value="2">单次消费-(单区间-百分比)</label></span>  -->
                            <!-- <span><label><input type="radio" name="condition_type3" value="4" id="topCons">前　</label> <label><input type="number" name="condition_value4" value="1000" min="0">　名用户</label></span> -->
                            <span>
                                <label>
                                    <input type="radio" name="condition_type3" value="3" checked>
                                    累计消费-(多区间-固定额)
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type3" value="8">
                                    单次消费-(多区间-固定额)
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type3" value="9">
                                    每天首次消费-(多区间-固定额)
                                </label>
                            </span>
                            <br/>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type3" value="7">
                                    累计消费-(多区间-百分比)
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type3" value="5">
                                    单次消费-(多区间-百分比)
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type3" value="6">
                                    每天首次消费-(多区间-百分比)
                                </label>
                            </span>
                            <br/>
                            <span id="vipCondition" style="display:none;">
                                <label>
                                    <input type="radio" name="condition_type3" value="10">
                                    VIP特权返利-(多区间-百分比)
                                </label>
                            </span>
                            <br/>
                            <br/>
                            <span style="color: red"> 特别说明：消费返利场景中，返利都是指对单个游戏来说的。</span>
                        </div>

                        <div class="paymentType" style="display:none;">
                            <!-- <span><label><input type="radio" name="condition_type2" value="1"  checked>每天首次充值（单区间-百分比）</label></span>  -->
                            <span>
                                <label>
                                    <input type="radio" name="condition_type2" value="2" checked>
                                    每天首次充值（多区间-百分比）
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type2" value="3" >
                                    单次充值（多区间-百分比）
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type2" value="4">
                                    累计充值（多区间-百分比）
                                </label>
                            </span>
                            <br/>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type2" value="5" >
                                    每天首次充值（多区间-固定额）
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type2" value="6" >
                                    单次充值（多区间-固定额）
                                </label>
                            </span>
                            <span>
                                <label>
                                    <input type="radio" name="condition_type2" value="7" >
                                    累计充值（多区间-固定额）
                                </label>
                            </span>
                        </div>
                    </td>
                </tr>
                <tr class="sumType ct" style="display:none;">
                    <td>累计计算规则</td>
                    <td>
                        <span>
                            <label>
                                <input type="radio" name="sum_type" value="1" checked/>
                                全平台累计
                            </label>
                        </span>
                        <span>
                            <label>
                                <input type="radio" name="sum_type" value="2"/>
                                单游戏累计
                            </label>
                        </span>
                    </td>
                </tr>
                <tr class="loginClient ct">
                    <td>游戏大厅版本</td>
                    <td>
                        <span>
                            <label>
                                <input type="checkbox" name="game_version[1]" value="1" checked id="reverse">
                                全部（1.5.4以上）
                            </label>
                        </span>
                        <!--  <span><label><input type="checkbox" name="game_version[2]" value="2" checked>1.5.4</label></span>-->
                        <span>
                            <label>
                                <input type="checkbox" name="game_version[3]" value="1" checked>
                                1.5.5
                            </label>
                        </span>
                        <span>
                            <label>
                                <input type="checkbox" name="game_version[4]" value="1" checked>
                                1.5.6
                            </label>
                        </span>
                        <span>
                            <label>
                                <input type="checkbox" name="game_version[5]" value="1" checked>
                                1.5.7
                            </label>
                        </span>
                    </td>
                </tr>
                <tr class="ticketObject ct" style="display:none;">
                    <td>游戏券应用范围</td>
                    <td>
                        <span class="allGameHall">
                            <label>
                                <input type="radio" name="ticket_object" value="1" checked>
                                全平台
                            </label>
                        </span>
                        <span class="singleGame">
                            <label>
                                <input type="radio" name="ticket_object" value="2">
                                单个游戏
                            </label>
                        </span>
                        <br/>
                        <br/>
                        <span> 1) 全平台: 表示赠送的游戏券是游侠大厅所有的游戏都可以使用。</span>
                        <br/>
                        <span> 2) 单个游戏: 表示赠送的游戏券是固定游戏才可以使用。</span>
                    </td>
                </tr>
                <tr class="ct">
                    <td>赠送额度规则</td>
                    <td>
                        <ul class="myList" id="rule" style="display:none;">
                            <li>说明：满XX送YY <span style="color: red">删除某一个区间时必须从最后一个区间向前开始，每个区间必须连续。</span></li>
                            <li class="item" data-item="0">
                                <ul class="myList">
                                    <li>
                                        消费　&gt;=　
                                        <input type="number" name="ACoupon[0][section_start]" min="1" class="sortInput">
                                        　&lt;　
                                        <input type="number" name="ACoupon[0][section_end]" min="1" class="sortInput">
                                        　A币，送　
                                        <input type="number" name="ACoupon[0][backAmount]" min="1" class="sortInput">
                                        　<span name="ticketStr"></span>
                                        <span class="btn deleteItem" onclick="deleteItem(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li data-item="0" data-acoupon="0">
                                        <label>
                                            <span class="label">
                                                <span name="ticketStr"></span>1
                                            </span>
                                            <input type="text" name="ACoupon[0][denarr][0][Step]">
                                        </label>
                                        <label>
                                            <span>　有效期:  <span name="ticketStr"></span>生成后，第　</span>
                                            <input type="number" name="ACoupon[0][denarr][0][effect_start_time]" min="1">
                                        </label>
                                        <label>
                                            　天到　
                                            <input type="number" name="ACoupon[0][denarr][0][effect_end_time]" min="1">
                                        </label>
                                        <span class="btn" onclick="deleteACoupon(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li>
                                        <span class="btn" onclick="addACoupon(this)">
                                            <span><button type="button">添加一张<span name="ticketStr"></span></button></span>
                                        </span>
                                    </li>
                                </ul>
                            </li>
                            <li id="addItem">
                                <span class="btn" onclick="addItem(this)">
                                    <span><button type="button">添加一个规则</button></span>
                                </span>
                            </li>
                        </ul>

                        <ul class="notEveryCons myList" id="notEveryConsPrecent" >
                            <li>
                                <label>
                                    <span class="label">面额</span>
                                    <input type="number" name="denomination" value="" min="1">
                                </label>
                            </li>
                            <li>
                                <span name="ticketStr"></span>
                                <span class="label">有效期</span>
                                <label>
                                    <input type="radio" name="deadline" value="1" checked>
                                    1天
                                </label>
                                <label>
                                    <input type="radio" name="deadline" value="3">
                                    3天
                                </label>
                                <label>
                                    <input type="radio" name="deadline" value="7">
                                    7天
                                </label>
                            </li>
                        </ul>

                        <ul class="everyConsPrecentEveryDay1 myList" id ="everyConsPrecentEveryDay1" style="display:none;">
                            <li>
                                说明：消费某个区间段金额，返还指定百分比的<span name="ticketStr"></span>。<font style="color:red">最后一项配置，按&lt;=处理 </font>
                            </li>
                            <li class="item" data-item="0">
                                <ul class="myList">
                                    <li>
                                        消费　&gt;=　
                                        <input type="number" name="ACoupon1[0][section_start]" min="1" class="sortInput">
                                        　&lt;　
                                        <input type="number" name="ACoupon1[0][section_end]" min="1" class="sortInput">　
                                        A币，送
                                        <input type="number" name="ACoupon1[0][backPercent]" value="" min="1"> % <span name="ticketStr"></span> 填写(1-500之间的数字)
                                        <span class="btn deleteItem" onclick="deleteItem(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li>
                                        <span><span name="ticketStr"></span>生成后，第　</span>
                                        <input type="number" name="ACoupon1[0][effect_start_time]" min="1" >
                                        　天到　
                                        <input type="number" name="ACoupon1[0][effect_end_time]" min="1">
                                        天
                                    </li>
                                </ul>
                            </li>
                            <li id="addItem">
                                <span class="btn" onclick="addItem1(this)">
                                    <span><button type="button">添加新的返还额度</button></span>
                                </span>
                            </li>
                        </ul>

                        <ul class="everyConsPrecentEveryDay2 myList" id ="everyConsPrecentEveryDay2" style="display:none;">
                            <li>
                                说明：充值某个区间段金额，返还指定百分比的<span name="ticketStr"></span>。<font style="color:red"> 最后一项配置，按&lt;=处理 </font>
                            </li>
                            <li class="item" data-item="0">
                                <ul class="myList">
                                    <li>
                                        充值　&gt;=　
                                        <input type="number" name="ACoupon2[0][section_start]" min="1" class="sortInput">　&lt;　<input type="number" name="ACoupon2[0][section_end]" min="1" class="sortInput">　
                                        A币，送
                                        <input type="number" name="ACoupon2[0][backPercent]" value="" min="1"> % <span name="ticketStr"></span> 填写(1-500之间的数字)
                                        <span class="btn deleteItem" onclick="deleteItem(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li>
                                        <span>　<span name="ticketStr"></span>生成后，第　</span>
                                        <input type="number" name="ACoupon2[0][effect_start_time]" min="1" >
                                        　天到　
                                        <input type="number" name="ACoupon2[0][effect_end_time]" min="1">
                                        天
                                    </li>
                                </ul>
                            </li>
                            <li id="addItem">
                                <span class="btn" onclick="addItem2(this)">
                                    <span><button type="button">添加新的返还额度</button></span>
                                </span>
                            </li>
                        </ul>

                        <ul class="everyConsPrecentEveryDay3 myList" id ="everyConsPrecentEveryDay3" style="display:none;">
                            <li>
                                说明：VIP某个区间段消费，返还指定百分比的<span name="ticketStr"></span>。<font style="color:red">最后一项配置，按&lt;=处理 </font>
                            </li>
                            <li class="item" data-item="0">
                                <ul class="myList">
                                    <li>
                                        VIP &gt;=
                                        <input type="number" name="ACoupon3[0][section_start]" min="1" class="sortInput">　&lt;　VIP <input type="number" name="ACoupon3[0][section_end]" min="1" class="sortInput">　
                                        ，送 <input type="number" name="ACoupon3[0][backPercent]" value="" min="1"> % <span name="ticketStr"></span> 填写(1-500之间的数字)
                                        <span class="btn deleteItem" onclick="deleteItem(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li>
                                        <span>　<span name="ticketStr"></span>生成后，第　</span>
                                        <input type="number" name="ACoupon3[0][effect_start_time]" min="1" >
                                        　天到　
                                        <input type="number" name="ACoupon3[0][effect_end_time]" min="1">
                                          天
                                    </li>
                                </ul>
                            </li>
                            <li id="addItem">
                                <span class="btn" onclick="addItem3(this)">
                                    <span><button type="button">添加新的返还额度</button></span>
                                </span>
                            </li>
                        </ul>

                        <ul class="everyConsPrecentEveryDay4 myList" id ="everyConsPrecentEveryDay4" style="display:none;">
                            <li>
                                说明：满XX送YY <span style="color: red">删除某一个区间时必须从最后一个区间向前开始，每个区间必须连续。</span>
                            </li>
                            <li class="item" data-item="0">
                                <ul class="myList">
                                    <li>
                                        充值　&gt;=　
                                        <input type="number" name="ACoupon4[0][section_start]" min="1" class="sortInput">
                                        　&lt;　
                                        <input type="number" name="ACoupon4[0][section_end]" min="1" class="sortInput">
                                        　A币，送　
                                        <input type="number" name="ACoupon4[0][backAmount]" min="1" class="sortInput">
                                        　<span name="ticketStr"></span>
                                        <span class="btn deleteItem" onclick="deleteItem(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li data-item="0" data-acoupon="0">
                                        <label>
                                            <span class="label"><span name="ticketStr"></span>1</span>
                                            <input type="text" name="ACoupon4[0][denarr][0][Step]"></label>
                                        <label>
                                            <span>
                                                　有效期:
                                                <span name="ticketStr"></span>
                                                生成后，第　
                                            </span>
                                            <input type="number" name="ACoupon4[0][denarr][0][effect_start_time]" min="1">
                                        </label>
                                        <label>
                                            　天到　
                                            <input type="number" name="ACoupon4[0][denarr][0][effect_end_time]" min="1">
                                        </label>
                                        <span class="btn" onclick="deleteACoupon(this)">
                                            <span><button type="button">删除</button></span>
                                        </span>
                                    </li>
                                    <li>
                                        <span class="btn" onclick="addACoupon4(this)">
                                            <span><button type="button">添加一张<span name="ticketStr"></span></button></span>
                                        </span>
                                    </li>
                                </ul>
                            </li>
                            <li id="addItem">
                                <span class="btn" onclick="addItem4(this)">
                                    <span><button type="button">添加一个规则</button></span>
                                </span>
                            </li>
                        </ul>

                        <ul class="myList" id ="everyConsPrecent" style="display:none;">
                            <li>
                                <label>
                                    <span class="label">   A币 &gt;= </span>
                                    <input type="number" name="denominationCons" value="" min="1">
                                </label>
                            </li>
                            <li>
                                <label>
                                    <span class="label">返还比例</span>
                                    <input type="number" name="restorationCons" value="" min="1">
                                </label>
                                (1-500之间的数字)
                            </li>
                            <li>
                                <span class="label">有效期</span>
                                <label><input type="radio" name="deadlineCons" value="1" checked>1天</label>
                                <label><input type="radio" name="deadlineCons" value="3">3天</label>
                                <label><input type="radio" name="deadlineCons" value="7">7天</label>
                            </li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td><span class="btn2"><span><button type="submit">保存</button></span></span></td>
                </tr>
            </table>
        </form>
    </div>
    <script src="<?php echo $staticPath;?>/js/common/jquery-ui-timepicker.js"></script>
    <script>
        // JQuery.serializeObject;
        (function($){
            $.fn.serializeObject = function(){
                var self = this,
                    json = {},
                    push_counters = {},
                    patterns = {
                        "validate":	/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,
                        "key":		/[a-zA-Z0-9_]+|(?=\[\])/g,
                        "push":		/^$/,
                        "fixed":	/^\d+$/,
                        "named":	/^[a-zA-Z0-9_]+$/
                    };

                this.build = function(base, key, value){
                    base[key] = value;
                    return base;
                };

                this.push_counter = function(key){
                    if(push_counters[key] === undefined){
                        push_counters[key] = 0;
                    }
                    return push_counters[key]++;
                };

                $.each($(this).serializeArray(), function(){
                    // skip invalid keys
                    if(!patterns.validate.test(this.name)){
                        return;
                    }

                    var k,
                        keys = this.name.match(patterns.key),
                        merge = this.value,
                        reverse_key = this.name;
                    while((k = keys.pop()) !== undefined){
                        // adjust reverse_key
                        reverse_key = reverse_key.replace(new RegExp("\\[" + k + "\\]$"), '');
                        // push
                        if(k.match(patterns.push)){
                            merge = self.build([], self.push_counter(reverse_key), merge);
                        }
                        // fixed
                        else if(k.match(patterns.fixed)){
                            merge = self.build([], k, merge);
                        }
                        // named
                        else if(k.match(patterns.named)){
                            merge = self.build({}, k, merge);
                        }
                    }

                    json = $.extend(true, json, merge);
                });

                return json;
            };
        })(jQuery);
    </script>
    <script>
        $('.time').datetimepicker();
        $("#reverse").click(function () {//反选
            if($(this).attr('checked')){
                $(".loginClient :checkbox:not(:first)").attr('checked',true);
            } else {
                $(".loginClient :checkbox:not(:first)").attr('checked',false);
            }
        });

        //参与游戏游戏对象
        $('input[name="game_object"]').click(function(){
            $('#subject_id').hide();
            $('#vipCondition').hide();
            $('#game_object_addition_info').hide();
            $('input[name="subject_id"]').val('');
            $('input[name="game_object_addition_info"]').val('');
            $('.singleGame').show();
            $('.allGameHall').show();
            htype = $("#htype").val();
            gameObj = $(this).val();
            switch(gameObj){
                case '1':
                    if(htype == 4){
                        if($('#ticketType').val() == 2) {
                            $('.singleGame').hide();
                            $('.allGameHall input').attr("checked", true);
                        }
                    }
                    break;
                case '2':
                    $('#subject_id').show();
                    break;
                case '3':
                case '4':
                    $('#game_object_addition_info').show();
                    break;
            }

            if(htype == 3 && gameObj == 1) {
                $('#vipCondition').show();
            }
            initSumType();
        });

        function initSumType(){
            $('.sumType').hide();
            $("input[name='sum_type'][value='2']").removeAttr("disabled");
            gameObj = $("input[name='game_object']:checked").val();
            condition = $("input[name='condition_type2']:checked").val();
            if(gameObj ==1 ){
                $("input[name='sum_type'][value='1']").attr('checked', true);
                $("input[name='sum_type'][value='2']").attr("disabled", true);
            }
            if(condition == 4 || condition == 7){
                $('.sumType').show();
            }
        }

        //充值返利
        $('input[name="condition_type2"]').click(function(){
            initSumType();
        });

        $('#ticketType').change(function() {
            $('#htype').trigger('change');
        });

        //参与游戏的用户
        $('[name="hd_object"]').click(function(){
            $('#hd_object_addition_info').hide();
            $('input[name="hd_object_addition_info"]').val('');
            hd_object = $(this).val();
            if(hd_object == 2){
                $('#hd_object_addition_info').show();
            }
        });

        $(".loginClient :checkbox:not(:first)").click(function(){
            if(!$(this).attr('checked')){
                $("#reverse").attr('checked',false);
            }
            if($(".loginClient :checkbox:not(:first)").size() == $(".loginClient :checkbox:not(:first):checked").size()){
                $("#reverse").attr('checked',true);
            }
        });

        function initGameTicket(){
            htype = $("#htype").val();
            ticket_type = $("#ticketType").val();
            gameObj = $("input[name='game_object']:checked").val();

            switch(htype){
                case '2':
                    if(ticket_type == 2) {
                        $('.allGameHall').show();
                        $('.singleGame').show();
                    }
                    break;
                case '4':
                    if(ticket_type == 2){
                        if(gameObj == 1) {
                            $('.allGameHall').show();
                            $('.allGameHall input').attr("checked", true);
                        }else{
                            $('.singleGame').show();
                            $('.singleGame input').attr("checked", true);
                        }
                    }
                    break;
                case '3':
                    if(ticket_type == 2) {
                        $('.allGameHall').show();
                        $('.singleGame').show();
                    }
                    if(gameObj == 1) {
                        $('#vipCondition').show();
                    }
                    break;
            }
        }

        $('#htype').change(function() {
            $('.sumType').hide();
            $('#vipCondition').hide();
            $('.payment_game_obj_tips').hide();
            $('#hd_object_addition_info').hide();
            $('#game_object_addition_info').hide();
            $('#sdk_ver_info').hide();
            $('.singleGame').hide();
            $('.allGameHall').hide();
            //参与游戏游戏对象
            $("input[name='game_object']:eq(0)").attr("checked",true);
            //赠送条件
            $("input[name='condition_type3']:eq(0)").attr("checked",true);
            //充值条件
            $("input[name='condition_type2']:eq(0)").attr("checked",true);
            ticket_type = $("#ticketType").val();
            gameObj = $("input[name='game_object']:checked").val();
            switch (this.value){
                case '1':
                    document.getElementById('firstLogin').checked = true;
                    $('.loginClient').show();
                    $('#subject_id').hide();
                    $('.notCons').show();
                    $('.cons').hide();
                    $(".paymentType").hide();
                    $('.notLoginClient').hide();
                    if(ticket_type == 2){
                        $('.allGameHall').show();
                        $('.allGameHall input').attr("checked", true);
                    }
                    break;
                case '2':
                    $('.notLoginClient').show();
                    $('.loginClient').hide();
                    $('#subject_id').hide();
                    $('.notCons').show();
                    $('.cons').hide();
                    $(".paymentType").hide();
                    $('#sdk_ver_info').show();
                    break;
                case '3':
                    $('.notLoginClient').show();
                    $('.loginClient').hide();
                    $('#subject_id').hide();
                    $('.notCons').hide();
                    $('.cons').show();
                    $(".paymentType").hide();
                    break;
                case '4':
                    $('.payment_game_obj_tips').show();
                    $('.notLoginClient').show();
                    $('.loginClient').hide();
                    $('#subject_id').hide();
                    $('.notCons').hide();
                    $('.cons').hide();
                    $(".paymentType").show();
                    break;
            }

            displayRule();
            initGameTicket();

            if(ticket_type==2){
                $('[name="ticketStr"]').html('游戏券');
                $('.ticketObject').show();
                return ;
            }

            $('.ticketObject').hide();
            $('[name="ticketStr"]').html('A券');
        });

        $('[name="condition_type3"]').change(displayRule);
        $('[name="condition_type2"]').change(displayRule);

        function displayRule() {
            $('#notEveryConsPrecent').hide();
            $('#rule').hide();
            $('#everyConsPrecent').hide();
            $('#everyConsPrecentEveryDay1').hide();
            $('#everyConsPrecentEveryDay3').hide();
            $('#everyConsPrecentEveryDay2').hide();
            $('#everyConsPrecentEveryDay4').hide();
            if ($('#htype').val() == 3 ){
                condition = $('[name="condition_type3"]:checked').val();
                switch(condition){
                    case '2':
                        $('#everyConsPrecent').show();
                        break;
                    case '3':
                    case '8':
                    case '9':
                        $('#rule').show();
                        break;
                    case '5':
                    case '6':
                    case '7':
                        $('#everyConsPrecentEveryDay1').show();
                        break;
                    case '10':
                        $('#everyConsPrecentEveryDay3').show();
                        break;
                }
            }else if($('#htype').val() == 4){
                condition = $('[name="condition_type2"]:checked').val();
                switch(condition){
                    case '1':
                        $('#everyConsPrecent').show();
                        break;
                    case '2':
                    case '3':
                    case '4':
                        $('#everyConsPrecentEveryDay2').show();
                        break;
                    case '5':
                    case '6':
                    case '7':
                        $('#everyConsPrecentEveryDay4').show();
                        break;
                }
            }else {
                $('#notEveryConsPrecent').show();
            }
        }
        $('#add_form').submit(function() {
            var info = $(this).serializeObject(),
                data = {
                    token: info.token,
                    title: info.title,
                    hd_start_time: info.hd_start_time,
                    hd_end_time: info.hd_end_time,
                    htype: info.htype,
                    ticket_type: info.ticket_type,
                    status: info.status,
                    hd_object: info.hd_object
                };
            data.hd_object = info.hd_object;
            data.hd_object_addition_info = info.hd_object_addition_info;
            if(data.ticket_type == 2){
                data.ticket_object = info.ticket_object;
            }
            if (data.htype == 1) {
                data.condition_type = info.condition_type;
                data.game_version = info.game_version;
                data.denomination = info.denomination;
                data.deadline = info.deadline;
            } else if (data.htype == 2) {
                data.condition_type = info.condition_type;
                data.game_object = info.game_object;
                data.game_object_addition_info = info.game_object_addition_info;
                data.denomination = info.denomination;
                data.deadline = info.deadline;
                data.subject_id = info.subject_id;
            } else if (data.htype == 3) {
                data.condition_type = info.condition_type3;
                data.game_object = info.game_object;
                data.game_object_addition_info = info.game_object_addition_info;
                data.subject_id = info.subject_id;
                switch(data.condition_type){
                    case '1':
                        data.denomination = info.denomination;
                        data.deadline = info.deadline;
                        break;
                    case '2':
                        data.restoration = info.restorationCons;
                        data.denomination = info.denominationCons;
                        data.deadline = info.deadlineCons;
                        if(data.restoration == ''){
                            alert('返还比例不能为空');
                            return false;
                        }
                        break;
                    case '3':
                    case '8':
                    case '9':
                        data.ACoupon = info.ACoupon;
                        for (var i in data.ACoupon) {
                            var item = data.ACoupon[i], sum = 0;
                            for (var d in item.denarr) {
                                sum += Number(item.denarr[d].Step);
                            }
                            if (sum != item.backAmount) {
                                alert('第 '+(1+Number(i))+' 个规则 代金券总数不符');
                                return false;
                            };
                        }
                        break;
                    case '4':
                        data.condition_value = info.condition_value4;
                        data.denomination = info.denomination;
                        data.deadline = info.deadline;
                        break;
                    case '5':
                    case '6':
                    case '7':
                        data.ACoupon = info.ACoupon1;
                        for (var i in data.ACoupon) {
                            var item = data.ACoupon[i];
                            if(item.backPercent == ''){
                                alert('第 '+(1+Number(i))+' 个规则 代金券返还比例不能为空。');
                                return false;
                            }
                            if (item.backPercent < 1 || item.backPercent > 500) {
                                alert('第 '+(1+Number(i))+' 个规则 代金券返还比例输入不合法。');
                                return false;
                            }
                        }
                        break;
                    case '10':
                        data.ACoupon = info.ACoupon3;
                        for (var i in data.ACoupon) {
                            var item = data.ACoupon[i];
                            if(item.backPercent == ''){
                                alert('第 '+(1+Number(i))+' 个规则 代金券返还比例不能为空。');
                                return false;
                            }
                            if (item.backPercent < 1 || item.backPercent > 500) {
                                alert('第 '+(1+Number(i))+' 个规则 代金券返还比例输入不合法。');
                                return false;
                            }
                        }
                        break;
                }
            }else if (data.htype == 4) {
                data.condition_type = info.condition_type2;
                data.game_object = info.game_object;
                data.game_object_addition_info = info.game_object_addition_info;
                data.subject_id = info.subject_id;
                //data.game_version = info.game_version;

                //充值选择累计充值条件，用来保存累计算法
                if(data.condition_type == 4 || data.condition_type == 7){
                    data.condition_value = info.sum_type;
                }

                switch(data.condition_type) {
                    case '1':
                        data.condition_value = info.payment_condition_value_1;
                        data.restoration = info.restorationCons;
                        data.denomination = info.denominationCons;
                        data.deadline = info.deadlineCons;
                        if(data.restoration == ''){
                            alert('返还比例不能为空');
                            return false;
                        }
                        break
                    case '2':
                    case '3':
                    case '4':
                        data.ACoupon = info.ACoupon2;
                        for (var i in data.ACoupon) {
                            var item = data.ACoupon[i];
                            if(item.backPercent == ''){
                                alert('第 '+(1+Number(i))+' 个规则 代金券返还比例不能为空。');
                                return false;
                            }
                            if (item.backPercent < 1 || item.backPercent > 500) {
                                alert('第 '+(1+Number(i))+' 个规则 代金券返还比例输入不合法。');
                                return false;
                            }
                        }
                        break;
                    case '5':
                    case '6':
                    case '7':
                        data.ACoupon = info.ACoupon4;
                        for (var i in data.ACoupon) {
                            var item = data.ACoupon[i], sum = 0;
                            for (var d in item.denarr) {
                                sum += Number(item.denarr[d].Step);
                            }
                            if (sum != item.backAmount) {
                                alert('第 '+(1+Number(i))+' 个规则 代金券总数不符');
                                return false;
                            };
                        }
                        break;
                }
            }

            $.post(this.action, data, function(res) {
                if (res.success) {
                    alert('操作成功');
                    location.href = '<?php echo $listUrl; ?>';
                } else {
                    alert(res.msg);
                }
            });
            return false;
        });

        function addTicketStr(){
            $('[name="ticketStr"]').html('A券');
            if($('#ticketType').val() ==2){
                $('[name="ticketStr"]').html('游戏券');
                return ;
            }
        }

        function addACoupon(obj) {
            var $lastACouponObj = $(obj).parent().prev(),
                thisItem = $lastACouponObj.attr('data-item'),
                thisACoupon = 1+Number($lastACouponObj.attr('data-acoupon')),
                html = '<li data-item="'+thisItem+'" data-acoupon="'+thisACoupon+'"><label><span class="label"><span name="ticketStr"></span>'+(thisACoupon+1)+'</span><input type="number" name="ACoupon['+thisItem+'][denarr]['+thisACoupon+'][Step]" min="1"></label><label><span>　有效期:  <span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon['+thisItem+'][denarr]['+thisACoupon+'][effect_start_time]" min="1"></label><label>　天到　<input type="number" name="ACoupon['+thisItem+'][denarr]['+thisACoupon+'][effect_end_time]" min="1"></label><span class="btn" onclick="deleteACoupon(this)"><span><button type="button">删除</button></span></span></li>';
            $lastACouponObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function addItem(obj) {
            var $lastItemObj = $(obj).parent().prev(),
                thisItem = 1+Number($lastItemObj.attr('data-item')),
                html = '<li class="item" data-item="'+thisItem+'"><ul class="myList"><li>消费　&gt;=　<input type="number" name="ACoupon['+thisItem+'][section_start]" min="1" class="sortInput">　&lt;　<input type="number" name="ACoupon['+thisItem+'][section_end]" min="1" class="sortInput">　A币，送　<input type="number" name="ACoupon['+thisItem+'][backAmount]" min="1" class="sortInput">　<span name="ticketStr"></span><span class="btn deleteItem" onclick="deleteItem(this)"><span><button type="button">删除</button></span></span></li><li data-item="'+thisItem+'" data-acoupon="0"><label><span class="label"><span name="ticketStr"></span>1</span><input type="number" name="ACoupon['+thisItem+'][denarr][0][Step]" min="1"></label><label><span>　有效期:  <span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon['+thisItem+'][denarr][0][effect_start_time]" min="1"></label><label>　天到　<input type="number" name="ACoupon['+thisItem+'][denarr][0][effect_end_time]" min="1"></label></li><li><span class="btn" onclick="addACoupon(this)"><span><button type="button">添加一张<span name="ticketStr"></span></button></span></span></li></ul></li>';
            $lastItemObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function addItem1(obj){
            var $lastItemObj = $(obj).parent().prev(),
                thisItem = 1+Number($lastItemObj.attr('data-item')),
                html = '<li class="item" data-item="'+thisItem+'"><ul class="myList"><li>消费　&gt;=　<input type="number" name="ACoupon1['+thisItem+'][section_start]" min="1" class="sortInput">　&lt;　<input type="number" name="ACoupon1['+thisItem+'][section_end]" min="1" class="sortInput"> A币，送 <input type="number" name="ACoupon1['+thisItem+'][backPercent]" value="" min="1"> % <span name="ticketStr"></span> 填写(1-500之间的数字) <span class="btn deleteItem" onclick="deleteItem(this)"><span><button type="button">删除</button></span></span></li><li><span>　<span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon1['+thisItem+'][effect_start_time]" min="1"> 天到 <input type="number" name="ACoupon1['+thisItem+'][effect_end_time]" min="1"> 天 </li></ul></li>';
            $lastItemObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function addItem2(obj){
            var $lastItemObj = $(obj).parent().prev(),
                thisItem = 1+Number($lastItemObj.attr('data-item')),
                html = '<li class="item" data-item="'+thisItem+'"><ul class="myList"><li>充值　&gt;=　<input type="number" name="ACoupon2['+thisItem+'][section_start]" min="1" class="sortInput">　&lt;　<input type="number" name="ACoupon2['+thisItem+'][section_end]" min="1" class="sortInput"> A币，送 <input type="number" name="ACoupon2['+thisItem+'][backPercent]" value="" min="1"> % <span name="ticketStr"></span> 填写(1-500之间的数字) <span class="btn deleteItem" onclick="deleteItem(this)"><span><button type="button">删除</button></span></span></li><li><span>　<span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon2['+thisItem+'][effect_start_time]" min="1"> 天到 <input type="number" name="ACoupon2['+thisItem+'][effect_end_time]" min="1"> 天 </li></ul></li>';
            $lastItemObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function addItem3(obj){
            var $lastItemObj = $(obj).parent().prev(),
                thisItem = 1+Number($lastItemObj.attr('data-item')),
                html = '<li class="item" data-item="'+thisItem+'"><ul class="myList"><li>VIP　&gt;=　<input type="number" name="ACoupon3['+thisItem+'][section_start]" min="1" class="sortInput">　&lt;　VIP <input type="number" name="ACoupon3['+thisItem+'][section_end]" min="1" class="sortInput"> ，返还 <input type="number" name="ACoupon3['+thisItem+'][backPercent]" value="" min="1"> % <span name="ticketStr"></span> 填写(1-500之间的数字) <span class="btn deleteItem" onclick="deleteItem(this)"><span><button type="button">删除</button></span></span></li><li><span>　<span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon3['+thisItem+'][effect_start_time]" min="1"> 天到 <input type="number" name="ACoupon3['+thisItem+'][effect_end_time]" min="1"> 天 </li></ul></li>';
            $lastItemObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function addACoupon4(obj) {
            var $lastACouponObj = $(obj).parent().prev(),
                thisItem = $lastACouponObj.attr('data-item'),
                thisACoupon = 1+Number($lastACouponObj.attr('data-acoupon')),
                html = '<li data-item="'+thisItem+'" data-acoupon="'+thisACoupon+'"><label><span class="label"><span name="ticketStr"></span>'+(thisACoupon+1)+'</span><input type="number" name="ACoupon4['+thisItem+'][denarr]['+thisACoupon+'][Step]" min="1"></label><label><span>　有效期:  <span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon4['+thisItem+'][denarr]['+thisACoupon+'][effect_start_time]" min="1"></label><label>　天到　<input type="number" name="ACoupon4['+thisItem+'][denarr]['+thisACoupon+'][effect_end_time]" min="1"></label><span class="btn" onclick="deleteACoupon(this)"><span><button type="button">删除</button></span></span></li>';
            $lastACouponObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function addItem4(obj) {
            var $lastItemObj = $(obj).parent().prev(),
                thisItem = 1+Number($lastItemObj.attr('data-item')),
                html = '<li class="item" data-item="'+thisItem+'"><ul class="myList"><li>充值　&gt;=　<input type="number" name="ACoupon4['+thisItem+'][section_start]" min="1" class="sortInput">　&lt;　<input type="number" name="ACoupon4['+thisItem+'][section_end]" min="1" class="sortInput">　A币，送　<input type="number" name="ACoupon4['+thisItem+'][backAmount]" min="1" class="sortInput">　<span name="ticketStr"></span><span class="btn deleteItem" onclick="deleteItem(this)"><span><button type="button">删除</button></span></span></li><li data-item="'+thisItem+'" data-acoupon="0"><label><span class="label"><span name="ticketStr"></span>1</span><input type="number" name="ACoupon4['+thisItem+'][denarr][0][Step]" min="1"></label><label><span>　有效期:  <span name="ticketStr"></span>生成后，第　</span><input type="number" name="ACoupon4['+thisItem+'][denarr][0][effect_start_time]" min="1"></label><label>　天到　<input type="number" name="ACoupon4['+thisItem+'][denarr][0][effect_end_time]" min="1"></label></li><li><span class="btn" onclick="addACoupon4(this)"><span><button type="button">添加一张<span name="ticketStr"></span></button></span></span></li></ul></li>';
            $lastItemObj.after(html).next().find('.time').datetimepicker();
            addTicketStr();
        }

        function deleteACoupon(obj) {
            var $obj = $(obj).parent();
            if ($obj.siblings().length == 2) {
                alert('不能全部删除');
                return;
            }
            $obj.remove();
        }

        function deleteItem(obj) {
            var $obj = $(obj).parent().parent().parent();
            console.log($obj.siblings().length);
            if ($obj.siblings().length == 2) {
                alert('不能全部删除');
                return;
            }
            $obj.remove();
        }
    </script>
<?php echo $this->render("layout/footer.phtml");?>