$(function(){

	var mode = {};
	$("div.sourceCode").each(function(){
		var pix = $(this).parents("article").index();
		var ix = $(this).parent("div.ace-editor-blocky").index();
		var langMode = $(this).attr("language").toLowerCase();
		if(mode[langMode] == 1){
			//相应的语言mode已经引入，不需要重复加载
		}else{
			//引入语言模型
			if(langMode == "sh")
				langMode = "per";
			var jsfile = $("<script charset=\"utf-8\" type=\"text/javascript\"></script>");
			jsfile.attr("src", "/Public/default/app/ace/mode-"+langMode+".js");
			$("body").append(jsfile);
			mode[langMode] = 1;
		}
		$(this).attr("id", "code_p_"+pix+"_"+ix);
	});
	$("div.sourceCode").each(function(){
		initCodeline($(this).attr("id"));
	})
})

function initCodeline(ID){
	var editor = ace.edit(ID);
	var langMode = $("div#"+ID).attr("language").toLowerCase();
	if(langMode == "sh")
		langMode = "per";
	//默认代码只读
	editor.setReadOnly(true);
	editor.resize();
	editor.setShowPrintMargin(false);
	//计算高度，高亮代码自适应高度
	var totline = editor.session.getLength()+2;
	var codeHeight = totline*20+"px";
	$("div#"+ID).parent("div").css({"height":codeHeight});
	editor.setTheme("ace/theme/clouds");
	var CodeMode = require("ace/mode/"+langMode).Mode;
	editor.getSession().setMode(new CodeMode());
}
